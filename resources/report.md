# 解题思路

## 整体思路

先搭建 MCP 整体框架（使用 MCP Python SDK），了解 AKShare 中关于 A股的 API 接口，而后对于任务，拆分成 1）数据获取；2）数据处理；其中，数据获取及参考 AKShare 的 API 接口获取到相应的数据，数据处理一方面是根据可编程的 metrics 计算得到一些指标，另一方面是根据整体数据、信息以及处理得到的指标使用 LLM 进行更加整体性的分析。

任务要求中的每个点，先单独实现为独立的 MCP Tools；在最后将所有 Tools 的结果汇总，交给 Inner-MCP LLM 进行综合分析，最后将整体分析得到的投资建议作为最终综合性 MCP Tool 的输出。

其中，在使用 AI Coding 工具时，AI 不知道 MCP 的概念以及如何编写（因为较新），直接使用网络搜索学习的效果也不太好，因此这部分需要人（我）来仔细阅读 MCP Python SDK 来建立起来整体的框架，以及配置好环境。
而后，和 AI 一起将其中的内容实现，对于 AKShare 的 API 接口使用过程中，AI 会产生比较强的 Hallucination，需要人（我）来仔细检查和纠正（这是因为 AKShare 的 API 文档过长，会很大程度上影响模型的注意力计算，从而导致错误，同时，这也影响了指令追踪的性能）。
面对 AKShare API 的长文档 + 代码的复杂性、以及开发过程中的多轮对话，AI 会面对整体 context 超出上下文限制的问题，这时需要使用者对整个信息库进行 Indexing（属于使用 RAG 来缓解超长上下文），来缓解上下文压力的同时保持效果。

在测试过程中发现数据获取失败的情况，因此采用两个思路来保证数据稳定性：
1. 使用重试机制：当数据获取失败时，自动重试多次
2. 使用多数据源：同时使用多个数据源获取数据，来增强数据的容错备份

## 基础框架
- 根据官方的MCP SDK搞定了基本框架
- 了解了akshare里面的function接口
- 处理好了akshare和mcp的兼容问题

## 任务
开始处理任务:
- 获取并分析个股财务数据
- 跟踪股价走势
- 计算关键财务指标
- 结合市场新闻进行综合分析
- 提供投资建议

### 获取并分析个股财务数据

1. 从多个akshare接口获取个股财务数据：

   - 东方财富个股基本信息:
   ```python
   ak.stock_individual_info_em(symbol=symbol_em, timeout=5)
   ```
   提取数据项：
     * 总市值：公司总股本乘以当前股价
     * 流通市值：流通股本乘以当前股价
     * 行业：公司所属行业分类
     * 上市时间：公司上市日期
     * 总股本：公司总发行股票数量
     * 流通股：可在市场交易的股票数量
     * 市盈率：用于估值分析的核心指标
   
   - 雪球公司概况数据:
   ```python
   ak.stock_individual_basic_info_xq(symbol=symbol_xq, timeout=5)
   ```
   提取数据项：
     * org_name_cn：公司中文名称
     * main_operation_business：主营业务描述
     * established_date：公司成立日期
     * staff_num：员工人数
     * reg_asset：注册资本
     * industry：所属行业
     * classi_name：企业性质分类
   
   - 实时盘口数据:
   ```python
   ak.stock_bid_ask_em(symbol=symbol_em)
   ```
   提取数据项：
     * 最新价：当前股票价格
     * 涨跌幅：当日价格变动百分比
     * 涨跌额：当日价格变动金额
     * 成交量：当日成交股数
     * 成交额：当日成交金额
     * 量比：当日成交量与过去5日平均成交量比值
     * 换手率：成交量占流通股本的百分比
     * 最高/最低：当日交易价格区间
     * 买卖盘价格和量：反映市场供需情况
   
   - 历史行情数据(90天):
   ```python
   ak.stock_zh_a_hist(symbol=symbol_em, period="daily", 
                     start_date=start_date, end_date=end_date, 
                     adjust="qfq")
   ```
   提取数据项：
     * 日期：交易日期
     * 开盘/收盘/最高/最低价：每日价格数据
     * 成交量：每日成交手数
     * 成交额：每日成交金额
     * 涨跌幅：每日价格变动百分比
     * 换手率：每日交易活跃度

2. 财务分析指标评定标准（暂定，与 AI 一起商量定下来的）：

   - 市场估值分析:
     * 市盈率(PE)评估：
       - < 15：低估值，可能具有投资价值
       - 15-30：中等估值，价格较为合理
       - \> 30：高估值，需谨慎投资
     * 量比评估：
       - \> 1.5：成交活跃度高于平均水平
       - ≤ 1.5：成交活跃度低于平均水平
     * 换手率评估：
       - \> 3%：市场交投活跃
       - ≤ 3%：市场交投较为平静
   
   - 技术指标分析:
     * 20日均线关系：
       - 股价 > 20日均线：短期走势偏强
       - 股价 < 20日均线：短期走势偏弱
     * 乖离率计算：(最新收盘价 - 20日均线) / 20日均线 × 100%
     * 波动率评估(近20交易日涨跌幅标准差)：
       - \> 3%：波动较大，风险较高
       - ≤ 3%：波动较小，相对稳定
   
   - 总体财务评估:
     * 优势指标：
       - 市盈率 < 15（低估值）
       - 量比 > 1.5（成交活跃）
       - 近90天涨幅 > 10%（走势强劲）
     * 劣势指标：
       - 市盈率 > 30（高估值）
       - 近90天跌幅 > 10%（走势疲软）
     * 投资建议：
       - 优势多于劣势：可考虑关注
       - 劣势多于优势：建议谨慎
       - 优势与劣势相当：中性观望

### 跟踪股价走势

1. akshare接口使用
   ```python
   # 获取股票历史数据
   stock_data = ak.stock_zh_a_hist(
       symbol=symbol,           # 股票代码，如: "600519"
       period=period,           # 数据周期: "daily", "weekly", "monthly"
       start_date=start_date,   # 开始日期，格式: "20240101"
       end_date=end_date,       # 结束日期，格式: "20240414" 
       adjust="qfq"             # 前复权数据
   )
   ```
   
   数据项说明:
   - 日期: 交易日期
   - 开盘/收盘/最高/最低价: 股票价格数据
   - 成交量: 交易量（手）
   - 成交额: 交易金额（元）
   - 涨跌幅/涨跌额: 价格变动情况
   - 换手率: 交易活跃度指标

2. 给出股价走势图
   
   利用 mplfinance 库绘制专业K线图，具有以下特点:
   
   - 完整K线展示: 蜡烛图形式展示开盘、收盘、最高、最低价格
   - 成交量分析: 图表下方展示每日成交量情况
   - 多重均线: 添加5日、10日、20日、60日移动平均线，便于趋势判断
   - 中国风格配色: 红涨绿跌符合国内投资者习惯
   - 高清图像: 300dpi高清图像输出
   - 自动保存: 图表自动保存在项目的`stock_charts`目录下
   
   使用示例:
   ```python
    {
        symbol="600519",  # 贵州茅台股票代码
        period="daily",   # 日频数据
        days=15           # 获取最近15天数据
    }
   ```
   
   功能亮点:
   - 自动计算关键技术指标: 移动平均线、价格变动等
   - 提供详细统计数据: 区间涨跌幅、最高/最低价、振幅等
   - 成交量分析: 当前成交量与平均水平比较
   - 直观图形展示: 趋势、支撑位、阻力位一目了然

### 计算关键财务指标

本功能提供对个股财务状况的全面分析，基于多种量化指标，从盈利能力、成长性、风险波动和技术趋势等多角度进行评估。这些分析有助于投资者做出更理性的投资决策。

#### 1. 指标体系

**盈利能力指标**
- **市盈率(PE)**: 衡量股票相对于其每股收益的价格水平
  - < 0: 负值，表明公司当前处于亏损状态
  - < 15: 较低，可能被低估或存在风险因素
  - 15-30: 处于合理区间，符合行业平均水平
  - 30-50: 较高，投资者对公司未来增长预期较强
  - \> 50: 极高，可能存在泡沫或特殊增长预期
  
- **市净率(PB)**: 衡量股票相对于其每股净资产的价格水平
  - < 1: 低于账面价值，可能被低估或资产回报率较低
  - 1-3: 处于合理区间，符合一般企业估值水平
  - \> 3: 较高，表明市场对公司资产质量评价较高

**成长性指标**
- **年度涨跌幅**: 过去一年的股价变动百分比
  - \> 30%: 强劲增长，显著跑赢大盘
  - 10%-30%: 良好增长，表现优于市场平均水平
  - 0%-10%: 小幅增长，基本符合市场表现
  - -10%-0%: 小幅下跌，略低于市场表现
  - < -10%: 大幅下跌，表现不佳

- **年化波动率**: 股价波动的剧烈程度，反映风险水平
  - < 20%: 低波动性，价格相对稳定
  - 20%-30%: 中等波动性，符合行业平均水平
  - 30%-40%: 较高波动性，价格波动较大
  - \> 40%: 高波动性，价格剧烈波动，风险较高

- **夏普比率**: 超额收益与风险的比率，衡量风险调整后的回报
  - < 0: 负值，表明投资回报低于无风险利率
  - 0-0.5: 较低，风险调整后回报不佳
  - 0.5-1: 一般，风险和回报较为平衡
  - 1-2: 良好，提供了较好的风险调整后回报
  - \> 2: 优秀，提供了极佳的风险调整后回报

**流动性与交易指标**
- **换手率**: 股票流通股本的交易活跃度
  - < 1%: 低换手，交易不活跃，可能缺乏市场关注
  - 1%-3%: 正常换手，交易活跃度适中
  - 3%-7%: 高换手，交易较为活跃
  - \> 7%: 极高换手，可能有重大事件或炒作

- **量比**: 当前成交量与近期平均成交量的比值
  - < 0.8: 成交低迷，人气不足
  - 0.8-1: 成交量低于近期平均
  - 1-2: 处于正常范围，交易情况平稳
  - 2-3: 成交活跃，有大资金介入迹象
  - \> 3: 成交异常活跃，可能有重大资金异动

**技术指标**
- **移动平均线分析**: 通过计算短、中、长期均线关系判断趋势
  - 多头排列(MA5 \> MA10 \> MA20): 短期走势强劲
  - 空头排列(MA5 < MA10 < MA20): 短期走势疲软
  - 均线交叉: 趋势不明确，可能处于变化中

- **MACD指标分析**: 依据DIF与DEA的相对位置及其在零轴的位置判断买卖信号
  - MACD金叉且在零轴上方: 强烈买入信号
  - MACD金叉但在零轴下方: 弱买入信号
  - MACD死叉且在零轴下方: 强烈卖出信号
  - MACD死叉但在零轴上方: 弱卖出信号

**市场与行业对比分析**
- 与A股整体市场平均市盈率的对比：
  - 显著低于市场平均(< -20%): 可能被低估或存在风险因素
  - 略低于市场平均(-20% ~ 0%): 估值相对合理
  - 略高于市场平均(0% ~ 20%): 估值相对合理
  - 显著高于市场平均(> 20%): 可能存在高估风险
- 行业板块热度与资金活跃度：
  - 结合公司所属行业的年度成交金额及占比，判断是否为市场主流热点板块，揭示行业资金关注度
- 换手率、量比与市场/行业均值对比：
  - 个股换手率、量比与市场或行业均值进行横向比较，判断其在市场中的活跃度分位
- 阶段高低点分位分析：
  - 分析当前收盘价在近一段时间（如90日、1年）区间的分位，辅助判断估值和技术压力/支撑位

#### 2. 综合评分体系

本系统采用100分制的综合评分体系，通过对各项指标的加权计算得出最终评分，并提供相应的投资建议：

- **90-100分**: 极佳评级，各项指标表现出色
- **80-90分**: 优质投资标的，财务指标表现优秀
- **70-80分**: 良好投资标的，财务指标表现良好
- **60-70分**: 一般投资标的，财务指标表现中等
- **50-60分**: 谨慎投资，财务指标存在一定问题
- **< 50分**: 不建议投资，财务指标表现较差

各指标评分标准:
- 市盈率评分(0-90分): 负值为0分；PE<10为90分；10≤PE<20为80分；20≤PE<30为60分；30≤PE<50为40分；PE≥50为20分
- 市净率评分(40-85分): PB<1为85分；1≤PB<2为80分；2≤PB<4为60分；PB≥4为40分
- 技术面评分(40-80分): 多头排列为80分；均线交叉为60分；空头排列为40分
- MACD评分(25-85分): 强烈买入信号为85分；买入信号为75分；弱买入信号为65分；弱卖出信号为45分；卖出信号为35分；强烈卖出信号为25分
- 波动率评分(30-80分): 波动率<20%为80分；20%≤波动率<30%为70分；30%≤波动率<40%为50分；波动率≥40%为30分
- 夏普比率评分(30-90分): 夏普比率<0为30分；0≤夏普比率<0.5为50分；0.5≤夏普比率<1为65分；1≤夏普比率<2为80分；夏普比率≥2为90分

### 结合市场新闻进行综合分析

本功能通过整合市场数据、行业成交情况、地区交易数据与个股表现，为投资者提供全方位的市场环境与投资建议分析。

#### 1. 分析维度

**市场宏观环境**
- 整体市场估值水平（市盈率）
- 市场总体成交情况
- 市场流动性分析

**行业分析**
- 行业成交额占比
- 行业成交量占比
- 行业在市场中的活跃度

**地区资金流向**
- 主要交易地区排名
- 地区交易额占比分析
- 资金地域流向趋势

**个股价格与交易分析**
- 近期价格走势
- 成交量变化趋势
- 价格波动特征分析

**综合分析与建议**
- 市场环境判断
- 个股资金流向
- 根据价格与成交量关系的投资建议
- 市场情绪评估

#### 2. 分析标准

**市场环境判断标准**
- 市场PE < 13: 当前市场整体估值处于历史低位，市场风险偏好较低
- 13 ≤ 市场PE < 16: 当前市场整体估值处于合理区间，投资者情绪中性
- 市场PE ≥ 16: 当前市场整体估值偏高，投资者风险偏好较高

**个股资金流向判断**
- 成交量变化 > 20%: 近期资金流入显著增加，存在积极做多迹象
- 0 < 成交量变化 ≤ 20%: 资金小幅流入，关注度有所提升
- -20% < 成交量变化 ≤ 0: 资金小幅流出，投资情绪趋于谨慎
- 成交量变化 ≤ -20%: 资金大幅流出，投资者信心不足

**投资建议标准**
- 价格上涨 > 10% 且 成交量增加: 股价走势强劲，成交量配合，短期可能继续上行
- 价格上涨 > 5% 但 成交量下降: 股价虽有上涨但成交量萎缩，上涨动能不足，建议谨慎追高
- 价格下跌 > 10% 但 成交量增加 > 20%: 股价大幅下跌但成交量放大，可能是强势资金介入迹象，可逢低关注
- 价格下跌 > 5% 且 成交量下降: 股价下跌且成交量萎缩，市场信心不足，建议暂时观望

**市场情绪评估标准**
- 上涨天数 > 下跌天数 × 2: 市场情绪强烈看多
- 上涨天数 > 下跌天数: 市场情绪偏向乐观
- 下跌天数 > 上涨天数 × 2: 市场情绪强烈看空
- 下跌天数 > 上涨天数: 市场情绪偏向悲观
- 上涨天数 ≈ 下跌天数: 市场情绪中性

#### 3. 风险提示

分析结果包含以下风险提示：
- 宏观经济风险: 经济增长放缓可能影响企业盈利
- 政策风险: 监管政策变化可能影响行业发展
- 流动性风险: 市场流动性变化可能导致价格波动
- 公司基本面风险: 业绩不及预期可能导致股价调整

### 使用Inner-LLM进行全部数据的综合分析并提供投资建议

在之前的每个部分中，都生成了对应的投资建议，这里我会使用 
```py
@mcp.tool()
def comprehensive_analysis(symbol: str) -> str
```
来做一个内部的 api calling 来达到，使用 AI 对所有数据进行分析的效果，这样可以保证个股分析的独立性，同时不会大量占据主LLM的上下文空间。
目前使用的是 openrouter 的 `google/gemini-2.5-pro-preview-03-25`

### 数据获取容错机制

本项目实现了强大的数据获取容错机制，确保API调用的稳定性：

```python
def retry_get_data(func, max_retries=3, retry_interval=1, **kwargs):
    """
    通用数据获取重试机制
    :param func: 数据获取函数（如 ak.xxx）
    :param max_retries: 最大重试次数
    :param retry_interval: 每次重试间隔秒数
    :param kwargs: 传递给 func 的参数
    :return: func 返回值或抛出最后一次异常
    """
```

该机制为所有数据源接口提供了自动重试能力，增强了程序的稳定性和容错性。

### 多种数据源接口

各工具使用的AKShare数据接口，共计21个：

#### 获取个股财务数据工具
- `ak.stock_individual_info_em` - 东方财富个股基本信息
- `ak.stock_individual_basic_info_xq` - 雪球个股基本信息
- `ak.stock_bid_ask_em` - 实时盘口数据
- `ak.stock_zh_a_hist` - 历史行情数据
- `ak.stock_profit_forecast_ths` - 同花顺预测年报净利润
- `ak.stock_yjkb_em` - 业绩快报
- `ak.stock_yjyg_em` - 业绩预告
- `ak.stock_em_analyst_detail` - 机构评级
- `ak.stock_em_analyst_rank_institute` - 备用机构评级
- `ak.stock_szse_sector_summary` - 行业平均估值
- `ak.stock_sse_summary` - 市场整体估值与换手率

#### 股价走势跟踪工具
- `ak.stock_zh_a_hist` - 股票历史行情数据

#### 市场新闻分析工具
- `ak.stock_news_em` - 个股新闻
- `ak.stock_hsgt_hist_em` - 北向资金历史
- `ak.stock_hsgt_board_rank_em` - 北向资金行业板块排行
- `ak.stock_individual_fund_flow` - 个股资金流
- `ak.stock_info_global_em` - 全球财经快讯-东财财富
- `ak.stock_info_global_sina` - 全球财经快讯-新浪财经
- `ak.stock_info_global_futu` - 全球财经快讯-富途牛牛
- `ak.stock_info_global_ths` - 全球财经直播-同花顺财经
- `ak.stock_info_global_cls` - 电报-财联社
